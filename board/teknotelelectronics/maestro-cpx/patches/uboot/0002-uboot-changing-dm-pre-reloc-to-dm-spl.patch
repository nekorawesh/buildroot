From 960d388fa527d9c57fc7adbe444b92989d1136e7 Mon Sep 17 00:00:00 2001
From: Mahdi Noori <nekorawesh@gmail.com>
Date: Mon, 22 Jun 2020 12:34:10 +0300
Subject: [PATCH 2/2] uboot: changing dm-pre-reloc to dm-spl

---
 arch/arm/dts/maestro-cpx-u-boot.dtsi | 24 +++++++++++++-----
 arch/arm/dts/maestro-cpx.dts         | 38 +++++++++++++++-------------
 2 files changed, 37 insertions(+), 25 deletions(-)

diff --git a/arch/arm/dts/maestro-cpx-u-boot.dtsi b/arch/arm/dts/maestro-cpx-u-boot.dtsi
index 14de3d8a08..b1e39f59d3 100755
--- a/arch/arm/dts/maestro-cpx-u-boot.dtsi
+++ b/arch/arm/dts/maestro-cpx-u-boot.dtsi
@@ -22,15 +22,12 @@
 
 	/* USER CODE BEGIN root */
 	aliases {
-		i2c3 = &i2c4;
+		i2c0 = &i2c4;
 		mmc0 = &sdmmc1;
 	};
 	config {
 		u-boot,boot-led = "alive";
 		u-boot,error-led = "comm";
-		st,adc_usb_pd = <&adc1 18>, <&adc1 19>;
-		st,fastboot-gpios = <&gpioa 13 GPIO_ACTIVE_LOW>;
-		st,stm32prog-gpios = <&gpioa 14 GPIO_ACTIVE_LOW>;
 	};
 	led {
 		red {
@@ -184,12 +181,22 @@
 };
 
 &sdmmc1{
-	u-boot,dm-pre-reloc;
+	u-boot,dm-spl;
 
 	/* USER CODE BEGIN sdmmc1 */
 	/* USER CODE END sdmmc1 */
 };
 
+sdmmc1_pins_mx: sdmmc1_mx-0 {
+		u-boot,dm-spl;
+		pins1 {
+			u-boot,dm-spl;
+		};
+		pins2 {
+			u-boot,dm-spl;
+		};
+	};
+
 &uart8{
 	u-boot,dm-pre-reloc;
 
@@ -247,12 +254,15 @@
 	u-boot,dm-pre-reloc;
 	pins1 {
 		u-boot,dm-pre-reloc;
-		/* pull-up on rx to avoid floating level */
-		bias-pull-up;
 	};
 	pins2 {
 		u-boot,dm-pre-reloc;
 	};
 };
+
+&usbotg_hs {
+	usb1600;
+	hnp-srp-disable;
+};
 /* USER CODE END addons */
 
diff --git a/arch/arm/dts/maestro-cpx.dts b/arch/arm/dts/maestro-cpx.dts
index c291eaca8c..b0ef8256f7 100755
--- a/arch/arm/dts/maestro-cpx.dts
+++ b/arch/arm/dts/maestro-cpx.dts
@@ -108,7 +108,7 @@
 		blue {
 			label = "alive";
 			gpios = <&gpiof 8 GPIO_ACTIVE_HIGH>;
-			linux,default-trigger = "heartbeat";
+			linux,default-trigger = "alive";
 			default-state = "off";
 		};
 	};
@@ -153,8 +153,6 @@
 }; /*root*/
 
 &pinctrl {
-	u-boot,dm-pre-reloc;
-
 	eth1_pins_mx: eth1_mx-0 {
 		pins1 {
 			pinmux = <STM32_PINMUX('A', 0, AF11)>, /* ETH1_CRS */
@@ -295,9 +293,9 @@
 	};
 
 	sdmmc1_pins_mx: sdmmc1_mx-0 {
-		u-boot,dm-pre-reloc;
+		u-boot,dm-spl;
 		pins1 {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('C', 8, AF12)>, /* SDMMC1_D0 */
 					 <STM32_PINMUX('C', 9, AF12)>, /* SDMMC1_D1 */
 					 <STM32_PINMUX('C', 10, AF12)>, /* SDMMC1_D2 */
@@ -308,7 +306,7 @@
 			slew-rate = <1>;
 		};
 		pins2 {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('C', 12, AF12)>; /* SDMMC1_CK */
 			bias-disable;
 			drive-push-pull;
@@ -317,9 +315,9 @@
 	};
 
 	sdmmc1_opendrain_pins_mx: sdmmc1_opendrain_mx-0 {
-		u-boot,dm-pre-reloc;
+		u-boot,dm-spl;
 		pins1 {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('C', 8, AF12)>, /* SDMMC1_D0 */
 					 <STM32_PINMUX('C', 9, AF12)>, /* SDMMC1_D1 */
 					 <STM32_PINMUX('C', 10, AF12)>, /* SDMMC1_D2 */
@@ -329,14 +327,14 @@
 			slew-rate = <1>;
 		};
 		pins2 {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('C', 12, AF12)>; /* SDMMC1_CK */
 			bias-disable;
 			drive-push-pull;
 			slew-rate = <2>;
 		};
 		pins3 {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('D', 2, AF12)>; /* SDMMC1_CMD */
 			bias-disable;
 			drive-open-drain;
@@ -345,9 +343,9 @@
 	};
 
 	sdmmc1_sleep_pins_mx: sdmmc1_sleep_mx-0 {
-		u-boot,dm-pre-reloc;
+		u-boot,dm-spl;
 		pins {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('C', 8, ANALOG)>, /* SDMMC1_D0 */
 					 <STM32_PINMUX('C', 9, ANALOG)>, /* SDMMC1_D1 */
 					 <STM32_PINMUX('C', 10, ANALOG)>, /* SDMMC1_D2 */
@@ -522,7 +520,6 @@
 	interrupt-parent = <&exti>;
 	interrupts = <68 1>;
 	interrupt-names = "wdg";
-	wakeup-source;
 	/* USER CODE END m4_rproc */
 
 	m4_system_resources{
@@ -665,6 +662,10 @@
 		wakeup-source;
 		status = "okay";
 
+		st,main-control-register = <0x04>;
+		st,vin-control-register = <0xc0>;
+		st,usb-control-register = <0x20>;
+
 		regulators {
 			compatible = "st,stpmic1-regulators";
 
@@ -808,7 +809,7 @@
 };
 
 &iwdg2{
-	status = "okay";
+	status = "disabled";
 
 	/* USER CODE BEGIN iwdg2 */
 	timeout-sec = <32>;
@@ -898,12 +899,9 @@
 };
 
 &pwr{
-	status = "okay";
-
 	/* USER CODE BEGIN pwr */
 	pwr-regulators {
 		vdd-supply = <&vdd>;
-		vdd_3v3_usbfs-supply = <&vdd_usb>;
 	};
 	/* USER CODE END pwr */
 };
@@ -931,7 +929,7 @@
 };
 
 &sdmmc1{
-	u-boot,dm-pre-reloc;
+	u-boot,dm-spl;
 	pinctrl-names = "default", "opendrain", "sleep";
 	pinctrl-0 = <&sdmmc1_pins_mx>;
 	pinctrl-1 = <&sdmmc1_opendrain_pins_mx>;
@@ -1035,6 +1033,10 @@
 	status = "okay";
 
 	/* USER CODE BEGIN usbotg_hs */
+	dr_mode = "peripheral";
+	force-b-session-valid;
+	phys = <&usbphyc_port1 0>;
+	phy-names = "usb2-phy";
 	/* USER CODE END usbotg_hs */
 };
 
-- 
2.27.0

