From dbaeac3d4d9e59f5bf695f912a961e36ca4046a4 Mon Sep 17 00:00:00 2001
From: Mahdi Noori <nekorawesh@gmail.com>
Date: Tue, 5 Jan 2021 17:46:50 +0300
Subject: [PATCH] adding ddr 512

---
 .../dts/maestro-cpx-ddr3-1x4Gb-1066-binG.dtsi | 121 -----
 arch/arm/dts/maestro-cpx-u-boot.dtsi          |  93 ++--
 arch/arm/dts/maestro-cpx.dts                  | 420 ++++++++++--------
 3 files changed, 279 insertions(+), 355 deletions(-)
 delete mode 100755 arch/arm/dts/maestro-cpx-ddr3-1x4Gb-1066-binG.dtsi

diff --git a/arch/arm/dts/maestro-cpx-ddr3-1x4Gb-1066-binG.dtsi b/arch/arm/dts/maestro-cpx-ddr3-1x4Gb-1066-binG.dtsi
deleted file mode 100755
index 09da7324f5..0000000000
--- a/arch/arm/dts/maestro-cpx-ddr3-1x4Gb-1066-binG.dtsi
+++ /dev/null
@@ -1,121 +0,0 @@
-/*
- * Copyright (C) 2015-2018, STMicroelectronics - All Rights Reserved
- *
- * SPDX-License-Identifier:	GPL-2.0+	BSD-3-Clause
- *
- */
-
-/*
- * File generated by STMicroelectronics STM32CubeMX DDR Tool for MPUs
- * DDR type: DDR3 / DDR3L
- * DDR width: 16bits
- * DDR density: 4Gb
- * System frequency: 533000Khz
- * Relaxed Timing Mode: false
- * Address mapping type: RBC
- *
- * Save Date: 2020.06.12, save Time: 18:48:00
- */
-
-#define DDR_MEM_NAME	"DDR3-DDR3L 16bits 533000Khz"
-#define DDR_MEM_SPEED	533000
-#define DDR_MEM_SIZE	0x20000000
-
-#define DDR_MSTR 0x00041401
-#define DDR_MRCTRL0 0x00000010
-#define DDR_MRCTRL1 0x00000000
-#define DDR_DERATEEN 0x00000000
-#define DDR_DERATEINT 0x00800000
-#define DDR_PWRCTL 0x00000000
-#define DDR_PWRTMG 0x00400010
-#define DDR_HWLPCTL 0x00000000
-#define DDR_RFSHCTL0 0x00210000
-#define DDR_RFSHCTL3 0x00000000
-#define DDR_RFSHTMG 0x0081008B
-#define DDR_CRCPARCTL0 0x00000000
-#define DDR_DRAMTMG0 0x121B2414
-#define DDR_DRAMTMG1 0x000A041C
-#define DDR_DRAMTMG2 0x0608090F
-#define DDR_DRAMTMG3 0x0050400C
-#define DDR_DRAMTMG4 0x08040608
-#define DDR_DRAMTMG5 0x06060403
-#define DDR_DRAMTMG6 0x02020002
-#define DDR_DRAMTMG7 0x00000202
-#define DDR_DRAMTMG8 0x00001005
-#define DDR_DRAMTMG14 0x000000A0
-#define DDR_ZQCTL0 0xC2000040
-#define DDR_DFITMG0 0x02060105
-#define DDR_DFITMG1 0x00000202
-#define DDR_DFILPCFG0 0x07000000
-#define DDR_DFIUPD0 0xC0400003
-#define DDR_DFIUPD1 0x00000000
-#define DDR_DFIUPD2 0x00000000
-#define DDR_DFIPHYMSTR 0x00000000
-#define DDR_ODTCFG 0x06000600
-#define DDR_ODTMAP 0x00000001
-#define DDR_SCHED 0x00000C01
-#define DDR_SCHED1 0x00000000
-#define DDR_PERFHPR1 0x01000001
-#define DDR_PERFLPR1 0x08000200
-#define DDR_PERFWR1 0x08000400
-#define DDR_DBG0 0x00000000
-#define DDR_DBG1 0x00000000
-#define DDR_DBGCMD 0x00000000
-#define DDR_POISONCFG 0x00000000
-#define DDR_PCCFG 0x00000010
-#define DDR_PCFGR_0 0x00010000
-#define DDR_PCFGW_0 0x00000000
-#define DDR_PCFGQOS0_0 0x02100C03
-#define DDR_PCFGQOS1_0 0x00800100
-#define DDR_PCFGWQOS0_0 0x01100C03
-#define DDR_PCFGWQOS1_0 0x01000200
-#define DDR_PCFGR_1 0x00010000
-#define DDR_PCFGW_1 0x00000000
-#define DDR_PCFGQOS0_1 0x02100C03
-#define DDR_PCFGQOS1_1 0x00800040
-#define DDR_PCFGWQOS0_1 0x01100C03
-#define DDR_PCFGWQOS1_1 0x01000200
-#define DDR_ADDRMAP1 0x00070707
-#define DDR_ADDRMAP2 0x00000000
-#define DDR_ADDRMAP3 0x1F000000
-#define DDR_ADDRMAP4 0x00001F1F
-#define DDR_ADDRMAP5 0x06060606
-#define DDR_ADDRMAP6 0x0F060606
-#define DDR_ADDRMAP9 0x00000000
-#define DDR_ADDRMAP10 0x00000000
-#define DDR_ADDRMAP11 0x00000000
-#define DDR_PGCR 0x01442E02
-#define DDR_PTR0 0x0022AA5B
-#define DDR_PTR1 0x04841104
-#define DDR_PTR2 0x042DA068
-#define DDR_ACIOCR 0x10400812
-#define DDR_DXCCR 0x00000C40
-#define DDR_DSGCR 0xF200011F
-#define DDR_DCR 0x0000000B
-#define DDR_DTPR0 0x38D488D0
-#define DDR_DTPR1 0x098B00D8
-#define DDR_DTPR2 0x10023600
-#define DDR_MR0 0x00000840
-#define DDR_MR1 0x00000000
-#define DDR_MR2 0x00000208
-#define DDR_MR3 0x00000000
-#define DDR_ODTCR 0x00010000
-#define DDR_ZQ0CR1 0x00000038
-#define DDR_DX0GCR 0x0000CE81
-#define DDR_DX0DLLCR 0x40000000
-#define DDR_DX0DQTR 0xFFFFFFFF
-#define DDR_DX0DQSTR 0x3DB02000
-#define DDR_DX1GCR 0x0000CE81
-#define DDR_DX1DLLCR 0x40000000
-#define DDR_DX1DQTR 0xFFFFFFFF
-#define DDR_DX1DQSTR 0x3DB02000
-#define DDR_DX2GCR 0x0000CE80
-#define DDR_DX2DLLCR 0x40000000
-#define DDR_DX2DQTR 0xFFFFFFFF
-#define DDR_DX2DQSTR 0x3DB02000
-#define DDR_DX3GCR 0x0000CE80
-#define DDR_DX3DLLCR 0x40000000
-#define DDR_DX3DQTR 0xFFFFFFFF
-#define DDR_DX3DQSTR 0x3DB02000
-
-#include "stm32mp15-ddr.dtsi"
diff --git a/arch/arm/dts/maestro-cpx-u-boot.dtsi b/arch/arm/dts/maestro-cpx-u-boot.dtsi
index c33bcdd486..bfd1ab15cc 100755
--- a/arch/arm/dts/maestro-cpx-u-boot.dtsi
+++ b/arch/arm/dts/maestro-cpx-u-boot.dtsi
@@ -1,6 +1,6 @@
 /* SPDX-License-Identifier: GPL-2.0+ OR BSD-3-Clause*/
 /*
- * Copyright (C) 2020, STMicroelectronics - All Rights Reserved
+ * Copyright (C) 2021, STMicroelectronics - All Rights Reserved
  * Author: STM32CubeMX code generation for STMicroelectronics.
  */
 
@@ -9,8 +9,10 @@
  */
 
 #include <dt-bindings/clock/stm32mp1-clksrc.h>
+#include "maestro-cpx.dtsi"
+
 #include "stm32mp15-u-boot.dtsi"
-#include "maestro-cpx-ddr3-1x4Gb-1066-binG.dtsi"
+#include "stm32mp15-ddr.dtsi"
 
 /* USER CODE BEGIN includes */
 /* USER CODE END includes */
@@ -24,22 +26,6 @@
 		u-boot,mmc-env-partition = "ssbl";
 	};
 
-	led {
-		alive {
-			label = "alive";
-			gpios = <&gpiof 8 GPIO_ACTIVE_HIGH>;
-			default-state = "off";
-			status = "okay";
-		};
-
-		comm {
-			label = "comm";
-			gpios = <&gpiof 10 GPIO_ACTIVE_LOW>;
-			default-state = "off";
-			status = "okay";
-		};
-	};
-
 	firmware {
 		optee {
 			compatible = "linaro,optee-tz";
@@ -56,51 +42,44 @@
 	/* USER CODE END root */
 
 	clocks {
-		u-boot,dm-pre-reloc;
-
 		/* USER CODE BEGIN clocks */
 		/* USER CODE END clocks */
 
+#ifndef CONFIG_STM32MP1_TRUSTED
 		clk_lsi: clk-lsi {
-			u-boot,dm-pre-reloc;
 
 			/* USER CODE BEGIN clk_lsi */
 			/* USER CODE END clk_lsi */
 		};
-
 		clk_hsi: clk-hsi {
-			u-boot,dm-pre-reloc;
 
 			/* USER CODE BEGIN clk_hsi */
 			/* USER CODE END clk_hsi */
 		};
-
 		clk_csi: clk-csi {
-			u-boot,dm-pre-reloc;
 			status = "disabled";
 
 			/* USER CODE BEGIN clk_csi */
 			/* USER CODE END clk_csi */
 		};
-
 		clk_lse: clk-lse {
-			u-boot,dm-pre-reloc;
 			st,drive = < LSEDRV_MEDIUM_HIGH >;
 
 			/* USER CODE BEGIN clk_lse */
 			/* USER CODE END clk_lse */
 		};
-
 		clk_hse: clk-hse {
-			u-boot,dm-pre-reloc;
 
 			/* USER CODE BEGIN clk_hse */
 			/* USER CODE END clk_hse */
 		};
+#endif	/*CONFIG_STM32MP1_TRUSTED*/
 	};
 
 }; /*root*/
 
+#ifndef CONFIG_STM32MP1_TRUSTED
+
 &rcc {
 	u-boot,dm-pre-reloc;
 	st,clksrc = <
@@ -129,7 +108,7 @@
 	>;
 	st,pkcs = <
 		CLK_CKPER_DISABLED
-		CLK_ETH_PLL3Q
+		CLK_ETH_PLL4P
 		CLK_SDMMC12_PLL4P
 		CLK_DSI_DSIPLL
 		CLK_STGEN_HSE
@@ -151,7 +130,7 @@
 		CLK_UART6_DISABLED
 		CLK_UART78_HSI
 		CLK_SPDIF_DISABLED
-		CLK_FDCAN_PLL4R
+		CLK_FDCAN_PLL4Q
 		CLK_SAI1_DISABLED
 		CLK_SAI2_DISABLED
 		CLK_SAI3_DISABLED
@@ -171,13 +150,13 @@
 	pll3:st,pll@2 {
 		compatible = "st,stm32mp1-pll";
 		reg = <2>;
-		cfg = < 1 49 2 4 5 PQR(1,1,0) >;
+		cfg = < 1 49 2 4 5 PQR(1,0,0) >;
 		u-boot,dm-pre-reloc;
 	};
 	pll4:st,pll@3 {
 		compatible = "st,stm32mp1-pll";
 		reg = <3>;
-		cfg = < 1 39 3 5 5 PQR(1,1,1) >;
+		cfg = < 1 39 3 5 5 PQR(1,1,0) >;
 		u-boot,dm-pre-reloc;
 	};
 };
@@ -189,27 +168,29 @@
 	/* USER CODE END i2c4 */
 };
 
-&rcc{
-	u-boot,dm-pre-reloc;
-
-	/* USER CODE BEGIN rcc */
-	/* USER CODE END rcc */
-};
-
 &sdmmc1{
-	u-boot,dm-spl;
+	u-boot,dm-pre-reloc;
 
 	/* USER CODE BEGIN sdmmc1 */
 	/* USER CODE END sdmmc1 */
 };
 
 &sdmmc2{
-	u-boot,dm-spl;
+	u-boot,dm-pre-reloc;
 
 	/* USER CODE BEGIN sdmmc2 */
 	/* USER CODE END sdmmc2 */
 };
 
+#endif	/*CONFIG_STM32MP1_TRUSTED*/
+
+&hash1{
+	u-boot,dm-pre-reloc;
+
+	/* USER CODE BEGIN hash1 */
+	/* USER CODE END hash1 */
+};
+
 &uart8{
 	u-boot,dm-pre-reloc;
 
@@ -217,6 +198,34 @@
 	/* USER CODE END uart8 */
 };
 
+&usbotg_hs{
+	u-boot,dm-pre-reloc;
+
+	/* USER CODE BEGIN usbotg_hs */
+	/* USER CODE END usbotg_hs */
+};
+
+&usbphyc{
+	u-boot,dm-pre-reloc;
+
+	/* USER CODE BEGIN usbphyc */
+	/* USER CODE END usbphyc */
+};
+
+&usbphyc_port0{
+	u-boot,dm-pre-reloc;
+
+	/* USER CODE BEGIN usbphyc_port0 */
+	/* USER CODE END usbphyc_port0 */
+};
+
+&usbphyc_port1{
+	u-boot,dm-pre-reloc;
+
+	/* USER CODE BEGIN usbphyc_port1 */
+	/* USER CODE END usbphyc_port1 */
+};
+
 /* USER CODE BEGIN addons */
 &pmic {
 	u-boot,dm-pre-reloc;
diff --git a/arch/arm/dts/maestro-cpx.dts b/arch/arm/dts/maestro-cpx.dts
index b9d4c3a0bd..6ad30fae92 100755
--- a/arch/arm/dts/maestro-cpx.dts
+++ b/arch/arm/dts/maestro-cpx.dts
@@ -1,6 +1,6 @@
 /* SPDX-License-Identifier: (GPL-2.0+ OR BSD-3-Clause) */
 /*
- * Copyright (C) STMicroelectronics 2020 - All Rights Reserved
+ * Copyright (C) STMicroelectronics 2021 - All Rights Reserved
  * Author: STM32CubeMX code generation for STMicroelectronics.
  */
 
@@ -9,23 +9,20 @@
  */
 
 /dts-v1/;
-/* USER CODE BEGIN includes */
-#include <dt-bindings/gpio/gpio.h>
-#include <dt-bindings/input/input.h>
-#include <dt-bindings/mfd/st,stpmic1.h>
-#include <dt-bindings/rtc/rtc-stm32.h>
-
 #include <dt-bindings/pinctrl/stm32-pinfunc.h>
 
 #include "stm32mp157.dtsi"
 #include "stm32mp15xa.dtsi"
 #include "stm32mp15xxab-pinctrl.dtsi"
 #include "stm32mp157-m4-srm.dtsi"
+
+/* USER CODE BEGIN includes */
+#include <dt-bindings/mfd/st,stpmic1.h>
 /* USER CODE END includes */
 
 / {
 	model = "Teknotel Electronics Maestro CPX";
-	compatible = "st,maestro-cpx", "st,stm32mp157";
+	compatible = "st,stm32mp157a-maestro-cpx", "st,stm32mp157";
 
 	memory@c0000000 {
 		device_type = "memory";
@@ -76,12 +73,12 @@
 			reg = <0x38000000 0x10000>;
 			no-map;
 		};
-		/* USER CODE END reserved-memory */
 
 		gpu_reserved: gpu@da000000 {
 			reg = <0xda000000 0x4000000>;
 			no-map;
 		};
+		/* USER CODE END reserved-memory */
 	};
 
 	/* USER CODE BEGIN root */
@@ -140,30 +137,30 @@
 		/* USER CODE BEGIN clocks */
 		/* USER CODE END clocks */
 
+#ifndef CONFIG_STM32MP1_TRUSTED
 		clk_lsi: clk-lsi {
 			clock-frequency = <32000>;
 		};
-
 		clk_hsi: clk-hsi {
 			clock-frequency = <64000000>;
 		};
-
 		clk_csi: clk-csi {
 			clock-frequency = <4000000>;
 		};
-
 		clk_lse: clk-lse {
 			clock-frequency = <32768>;
 		};
-
 		clk_hse: clk-hse {
 			clock-frequency = <24000000>;
 		};
+#endif	/*CONFIG_STM32MP1_TRUSTED*/
 	};
 
 }; /*root*/
 
 &pinctrl {
+	u-boot,dm-pre-reloc;
+
 	eth1_pins_mx: eth1_mx-0 {
 		pins1 {
 			pinmux = <STM32_PINMUX('A', 0, AF11)>, /* ETH1_CRS */
@@ -221,6 +218,26 @@
 		};
 	};
 
+	fdcan2_pins_mx: fdcan2_mx-0 {
+		pins1 {
+			pinmux = <STM32_PINMUX('B', 5, AF9)>; /* FDCAN2_RX */
+			bias-disable;
+		};
+		pins2 {
+			pinmux = <STM32_PINMUX('B', 6, AF9)>; /* FDCAN2_TX */
+			bias-disable;
+			drive-push-pull;
+			slew-rate = <0>;
+		};
+	};
+
+	fdcan2_sleep_pins_mx: fdcan2_sleep_mx-0 {
+		pins {
+			pinmux = <STM32_PINMUX('B', 5, ANALOG)>, /* FDCAN2_RX */
+					 <STM32_PINMUX('B', 6, ANALOG)>; /* FDCAN2_TX */
+		};
+	};
+
 	i2c1_pins_mx: i2c1_mx-0 {
 		pins {
 			pinmux = <STM32_PINMUX('B', 7, AF4)>, /* I2C1_SDA */
@@ -238,6 +255,23 @@
 		};
 	};
 
+	i2c2_pins_mx: i2c2_mx-0 {
+		pins {
+			pinmux = <STM32_PINMUX('D', 7, AF4)>, /* I2C2_SCL */
+					 <STM32_PINMUX('G', 15, AF4)>; /* I2C2_SDA */
+			bias-disable;
+			drive-open-drain;
+			slew-rate = <0>;
+		};
+	};
+
+	i2c2_sleep_pins_mx: i2c2_sleep_mx-0 {
+		pins {
+			pinmux = <STM32_PINMUX('D', 7, ANALOG)>, /* I2C2_SCL */
+					 <STM32_PINMUX('G', 15, ANALOG)>; /* I2C2_SDA */
+		};
+	};
+
 	i2c4_pins_mx: i2c4_mx-0 {
 		u-boot,dm-pre-reloc;
 		pins {
@@ -261,65 +295,31 @@
 
 	m4_fdcan1_pins_mx: m4_fdcan1_mx-0 {
 		pins {
-			pinmux = <STM32_PINMUX('A', 11, ANALOG)>, /* FDCAN1_RX */
-					 <STM32_PINMUX('A', 12, ANALOG)>; /* FDCAN1_TX */
-		};
-	};
-
-	fdcan2_pins_mx: fdcan2_mx-0 {
-		pins1 {
-			pinmux = <STM32_PINMUX('B', 5, AF9)>; /* FDCAN2_RX */
-			bias-disable;
-		};
-		pins2 {
-			pinmux = <STM32_PINMUX('B', 6, AF9)>; /* FDCAN2_TX */
-			bias-disable;
-			drive-push-pull;
-			slew-rate = <0>;
-		};
-	};
-
-	fdcan2_sleep_pins_mx: fdcan2_sleep_mx-0 {
-		pins {
-			pinmux = <STM32_PINMUX('B', 5, ANALOG)>, /* FDCAN2_RX */
-					 <STM32_PINMUX('B', 6, ANALOG)>; /* FDCAN2_TX */
-		};
-	};
-
-	m4_i2c2_pins_mx: m4_i2c2_mx-0 {
-		pins {
-			pinmux = <STM32_PINMUX('D', 7, ANALOG)>, /* I2C2_SCL */
-					 <STM32_PINMUX('G', 15, ANALOG)>; /* I2C2_SDA */
+			pinmux = <STM32_PINMUX('A', 11, RSVD)>, /* FDCAN1_RX */
+					 <STM32_PINMUX('A', 12, RSVD)>; /* FDCAN1_TX */
 		};
 	};
 
 	m4_i2c5_pins_mx: m4_i2c5_mx-0 {
 		pins {
-			pinmux = <STM32_PINMUX('D', 0, ANALOG)>, /* I2C5_SDA */
-					 <STM32_PINMUX('D', 1, ANALOG)>; /* I2C5_SCL */
+			pinmux = <STM32_PINMUX('D', 0, RSVD)>, /* I2C5_SDA */
+					 <STM32_PINMUX('D', 1, RSVD)>; /* I2C5_SCL */
 		};
 	};
 
 	m4_spi4_pins_mx: m4_spi4_mx-0 {
 		pins {
-			pinmux = <STM32_PINMUX('E', 6, ANALOG)>, /* SPI4_MOSI */
-					 <STM32_PINMUX('E', 11, ANALOG)>, /* SPI4_NSS */
-					 <STM32_PINMUX('E', 12, ANALOG)>, /* SPI4_SCK */
-					 <STM32_PINMUX('E', 13, ANALOG)>; /* SPI4_MISO */
-		};
-	};
-
-	m4_usart2_pins_mx: m4_usart2_mx-0 {
-		pins {
-			pinmux = <STM32_PINMUX('D', 5, ANALOG)>, /* USART2_TX */
-					 <STM32_PINMUX('D', 6, ANALOG)>; /* USART2_RX */
+			pinmux = <STM32_PINMUX('E', 6, RSVD)>, /* SPI4_MOSI */
+					 <STM32_PINMUX('E', 11, RSVD)>, /* SPI4_NSS */
+					 <STM32_PINMUX('E', 12, RSVD)>, /* SPI4_SCK */
+					 <STM32_PINMUX('E', 13, RSVD)>; /* SPI4_MISO */
 		};
 	};
 
 	sdmmc1_pins_mx: sdmmc1_mx-0 {
-		u-boot,dm-spl;
+		u-boot,dm-pre-reloc;
 		pins1 {
-			u-boot,dm-spl;
+			u-boot,dm-pre-reloc;
 			pinmux = <STM32_PINMUX('C', 8, AF12)>, /* SDMMC1_D0 */
 					 <STM32_PINMUX('C', 9, AF12)>, /* SDMMC1_D1 */
 					 <STM32_PINMUX('C', 10, AF12)>, /* SDMMC1_D2 */
@@ -330,7 +330,7 @@
 			slew-rate = <1>;
 		};
 		pins2 {
-			u-boot,dm-spl;
+			u-boot,dm-pre-reloc;
 			pinmux = <STM32_PINMUX('C', 12, AF12)>; /* SDMMC1_CK */
 			bias-disable;
 			drive-push-pull;
@@ -339,9 +339,9 @@
 	};
 
 	sdmmc1_opendrain_pins_mx: sdmmc1_opendrain_mx-0 {
-		u-boot,dm-spl;
+		u-boot,dm-pre-reloc;
 		pins1 {
-			u-boot,dm-spl;
+			u-boot,dm-pre-reloc;
 			pinmux = <STM32_PINMUX('C', 8, AF12)>, /* SDMMC1_D0 */
 					 <STM32_PINMUX('C', 9, AF12)>, /* SDMMC1_D1 */
 					 <STM32_PINMUX('C', 10, AF12)>, /* SDMMC1_D2 */
@@ -351,14 +351,14 @@
 			slew-rate = <1>;
 		};
 		pins2 {
-			u-boot,dm-spl;
+			u-boot,dm-pre-reloc;
 			pinmux = <STM32_PINMUX('C', 12, AF12)>; /* SDMMC1_CK */
 			bias-disable;
 			drive-push-pull;
 			slew-rate = <2>;
 		};
 		pins3 {
-			u-boot,dm-spl;
+			u-boot,dm-pre-reloc;
 			pinmux = <STM32_PINMUX('D', 2, AF12)>; /* SDMMC1_CMD */
 			bias-disable;
 			drive-open-drain;
@@ -367,9 +367,9 @@
 	};
 
 	sdmmc1_sleep_pins_mx: sdmmc1_sleep_mx-0 {
-		u-boot,dm-spl;
+		u-boot,dm-pre-reloc;
 		pins {
-			u-boot,dm-spl;
+			u-boot,dm-pre-reloc;
 			pinmux = <STM32_PINMUX('C', 8, ANALOG)>, /* SDMMC1_D0 */
 					 <STM32_PINMUX('C', 9, ANALOG)>, /* SDMMC1_D1 */
 					 <STM32_PINMUX('C', 10, ANALOG)>, /* SDMMC1_D2 */
@@ -380,9 +380,9 @@
 	};
 
 	sdmmc2_b4_pins_mx: sdmmc2_b4_mx-0 {
-		u-boot,dm-spl;
+		u-boot,dm-pre-reloc;
 		pins1 {
-			u-boot,dm-spl;
+			u-boot,dm-pre-reloc;
 			pinmux = <STM32_PINMUX('B', 14, AF9)>, /* SDMMC2_D0 */
 					 <STM32_PINMUX('B', 15, AF9)>, /* SDMMC2_D1 */
 					 <STM32_PINMUX('B', 3, AF9)>, /* SDMMC2_D2 */
@@ -393,7 +393,7 @@
 			bias-pull-up;
 		};
 		pins2 {
-			u-boot,dm-spl;
+			u-boot,dm-pre-reloc;
 			pinmux = <STM32_PINMUX('E', 3, AF9)>; /* SDMMC2_CK */
 			slew-rate = <2>;
 			drive-push-pull;
@@ -402,9 +402,9 @@
 	};
 
 	sdmmc2_b4_opendrain_pins_mx: sdmmc2_b4_opendrain_mx-0 {
-		u-boot,dm-spl;
+		u-boot,dm-pre-reloc;
 		pins1 {
-			u-boot,dm-spl;
+			u-boot,dm-pre-reloc;
 			pinmux = <STM32_PINMUX('B', 14, AF9)>, /* SDMMC2_D0 */
 					 <STM32_PINMUX('B', 15, AF9)>, /* SDMMC2_D1 */
 					 <STM32_PINMUX('B', 3, AF9)>, /* SDMMC2_D2 */
@@ -414,14 +414,14 @@
 			bias-pull-up;
 		};
 		pins2 {
-			u-boot,dm-spl;
+			u-boot,dm-pre-reloc;
 			pinmux = <STM32_PINMUX('E', 3, AF9)>; /* SDMMC2_CK */
 			slew-rate = <2>;
 			drive-push-pull;
 			bias-pull-up;
 		};
 		pins3 {
-			u-boot,dm-spl;
+			u-boot,dm-pre-reloc;
 			pinmux = <STM32_PINMUX('G', 6, AF10)>; /* SDMMC2_CMD */
 			slew-rate = <1>;
 			drive-open-drain;
@@ -430,9 +430,9 @@
 	};
 
 	sdmmc2_b4_sleep_pins_mx: sdmmc2_b4_sleep_mx-0 {
-		u-boot,dm-spl;
+		u-boot,dm-pre-reloc;
 		pins {
-			u-boot,dm-spl;
+			u-boot,dm-pre-reloc;
 			pinmux = <STM32_PINMUX('B', 14, ANALOG)>, /* SDMMC2_D0 */
 					 <STM32_PINMUX('B', 15, ANALOG)>, /* SDMMC2_D1 */
 					 <STM32_PINMUX('B', 3, ANALOG)>, /* SDMMC2_D2 */
@@ -443,9 +443,9 @@
 	};
 
 	sdmmc2_d47_pins_mx: sdmmc2_d47_mx-0 {
-		u-boot,dm-spl;
+		u-boot,dm-pre-reloc;
 		pins1 {
-			u-boot,dm-spl;
+			u-boot,dm-pre-reloc;
 			pinmux = <STM32_PINMUX('A', 8, AF9)>, /* SDMMC2_D4 */
 					 <STM32_PINMUX('B', 9, AF10)>, /* SDMMC2_D5 */
 					 <STM32_PINMUX('E', 5, AF9)>, /* SDMMC2_D6 */
@@ -457,9 +457,9 @@
 	};
 
 	sdmmc2_d47_sleep_pins_mx: sdmmc2_d47_sleep_mx-0 {
-		u-boot,dm-spl;
+		u-boot,dm-pre-reloc;
 		pins {
-			u-boot,dm-spl;
+			u-boot,dm-pre-reloc;
 			pinmux = <STM32_PINMUX('A', 8, ANALOG)>, /* SDMMC2_D4 */
 					 <STM32_PINMUX('B', 9, ANALOG)>, /* SDMMC2_D5 */
 					 <STM32_PINMUX('E', 5, ANALOG)>, /* SDMMC2_D6 */
@@ -487,17 +487,23 @@
 		};
 	};
 
-	uart4_idle_pins_mx: uart4_idle_mx-0 {
+	uart8_pins_mx: uart8_mx-0 {
+		u-boot,dm-pre-reloc;
 		pins1 {
-			pinmux = <STM32_PINMUX('A', 13, ANALOG)>; /* UART4_TX */
+			u-boot,dm-pre-reloc;
+			pinmux = <STM32_PINMUX('E', 0, AF8)>; /* UART8_RX */
+			bias-disable;
 		};
 		pins2 {
-			pinmux = <STM32_PINMUX('B', 2, AF8)>; /* UART4_RX */
+			u-boot,dm-pre-reloc;
+			pinmux = <STM32_PINMUX('E', 1, AF8)>; /* UART8_TX */
 			bias-disable;
+			drive-push-pull;
+			slew-rate = <0>;
 		};
 	};
 
-	uart8_pins_mx: uart8_mx-0 {
+	uart8_idle_pins_mx: uart8_idle_mx-0 {
 		u-boot,dm-pre-reloc;
 		pins1 {
 			u-boot,dm-pre-reloc;
@@ -506,10 +512,7 @@
 		};
 		pins2 {
 			u-boot,dm-pre-reloc;
-			pinmux = <STM32_PINMUX('E', 1, AF8)>; /* UART8_TX */
-			bias-disable;
-			drive-push-pull;
-			slew-rate = <0>;
+			pinmux = <STM32_PINMUX('E', 1, ANALOG)>; /* UART8_TX */
 		};
 	};
 
@@ -522,16 +525,23 @@
 		};
 	};
 
-	uart8_idle_pins_mx: uart8_idle_mx-0 {
-		u-boot,dm-pre-reloc;
+	usart2_pins_mx: usart2_mx-0 {
 		pins1 {
-			u-boot,dm-pre-reloc;
-			pinmux = <STM32_PINMUX('E', 0, AF8)>; /* UART8_RX */
+			pinmux = <STM32_PINMUX('D', 5, AF7)>; /* USART2_TX */
 			bias-disable;
+			drive-push-pull;
+			slew-rate = <0>;
 		};
 		pins2 {
-			u-boot,dm-pre-reloc;
-			pinmux = <STM32_PINMUX('E', 1, ANALOG)>; /* UART8_TX */
+			pinmux = <STM32_PINMUX('D', 6, AF7)>; /* USART2_RX */
+			bias-disable;
+		};
+	};
+
+	usart2_sleep_pins_mx: usart2_sleep_mx-0 {
+		pins {
+			pinmux = <STM32_PINMUX('D', 5, ANALOG)>, /* USART2_TX */
+					 <STM32_PINMUX('D', 6, ANALOG)>; /* USART2_RX */
 		};
 	};
 
@@ -555,24 +565,18 @@
 		};
 	};
 
-	usart3_idle_pins_mx: usart3_idle_mx-0 {
-		pins1 {
-			pinmux = <STM32_PINMUX('D', 8, ANALOG)>; /* USART3_TX */
-		};
-		pins2 {
-			pinmux = <STM32_PINMUX('D', 9, AF7)>; /* USART3_RX */
-			bias-disable;
-		};
-	};
-
 	usb_otg_hs_pins_mx: usb_otg_hs_mx-0 {
+		u-boot,dm-pre-reloc;
 		pins {
+			u-boot,dm-pre-reloc;
 			pinmux = <STM32_PINMUX('A', 10, ANALOG)>; /* USB_OTG_HS_ID */
 		};
 	};
 
 	usb_otg_hs_sleep_pins_mx: usb_otg_hs_sleep_mx-0 {
+		u-boot,dm-pre-reloc;
 		pins {
+			u-boot,dm-pre-reloc;
 			pinmux = <STM32_PINMUX('A', 10, ANALOG)>; /* USB_OTG_HS_ID */
 		};
 	};
@@ -592,10 +596,11 @@
 	/*Restriction: "memory-region" property is not managed - please to use User-Section if needed*/
 	mboxes = <&ipcc 0>, <&ipcc 1>, <&ipcc 2>;
 	mbox-names = "vq0", "vq1", "shutdown";
-	recovery;
 	status = "okay";
 
 	/* USER CODE BEGIN m4_rproc */
+	memory-region = <&retram>, <&mcuram>, <&mcuram2>, <&vdev0vring0>,
+		<&vdev0vring1>, <&vdev0buffer>;
 	interrupt-parent = <&exti>;
 	interrupts = <68 1>;
 	interrupt-names = "wdg";
@@ -624,10 +629,74 @@
 	/* USER CODE END crc1 */
 };
 
+&dma1{
+	status = "okay";
+
+	/* USER CODE BEGIN dma1 */
+	sram = <&dma_pool>;
+	/* USER CODE END dma1 */
+};
+
+&dma2{
+	status = "disabled";
+
+	/* USER CODE BEGIN dma2 */
+	sram = <&dma_pool>;
+	/* USER CODE END dma2 */
+};
+
+&dmamux1{
+
+	dma-masters = <&dma1>;
+	dma-channels = <8>;
+
+	status = "okay";
+
+	/* USER CODE BEGIN dmamux1 */
+	/* USER CODE END dmamux1 */
+};
+
 &dsi{
 	status = "okay";
 
 	/* USER CODE BEGIN dsi */
+	#address-cells = <1>;
+	#size-cells = <0>;
+	status = "okay";
+
+	ports {
+		#address-cells = <1>;
+		#size-cells = <0>;
+
+		port@0 {
+			reg = <0>;
+			dsi_in: endpoint {
+				remote-endpoint = <&ltdc_ep1_out>;
+			};
+		};
+
+		port@1 {
+			reg = <1>;
+			dsi_out: endpoint {
+				remote-endpoint = <&panel_in>;
+			};
+		};
+	};
+
+	panel: panel@0 {
+		compatible = "orisetech,otm8009a";
+		reg = <0>;
+		reset-gpios = <&gpioe 4 GPIO_ACTIVE_LOW>;
+		power-supply = <&v3v3>;
+		backlight = <&panel_backlight>;
+		status = "okay";
+
+		port {
+			panel_in: endpoint {
+				remote-endpoint = <&dsi_out>;
+			};
+		};
+	};
 	/* USER CODE END dsi */
 };
 
@@ -650,7 +719,6 @@
 	snps,reset-active-low = <1>;
 	local-mac-address = [00 80 ea 42 69 eb];
 	phy-mode = "mii";
-	max-speed = <100>;
 	phy-handle = <&phy0>;
 
 	mdio0 {
@@ -673,6 +741,7 @@
 };
 
 &hash1{
+	u-boot,dm-pre-reloc;
 	status = "okay";
 
 	/* USER CODE BEGIN hash1 */
@@ -723,6 +792,16 @@
 	/* USER CODE END i2c1 */
 };
 
+&i2c2{
+	pinctrl-names = "default", "sleep";
+	pinctrl-0 = <&i2c2_pins_mx>;
+	pinctrl-1 = <&i2c2_sleep_pins_mx>;
+	status = "okay";
+
+	/* USER CODE BEGIN i2c2 */
+	/* USER CODE END i2c2 */
+};
+
 &i2c4{
 	u-boot,dm-pre-reloc;
 	pinctrl-names = "default", "sleep";
@@ -862,7 +941,7 @@
 };
 
 &iwdg2{
-	status = "disabled";
+	status = "okay";
 
 	/* USER CODE BEGIN iwdg2 */
 	timeout-sec = <32>;
@@ -885,6 +964,16 @@
 	/* USER CODE END ltdc */
 };
 
+&m_can2{
+	pinctrl-names = "default", "sleep";
+	pinctrl-0 = <&fdcan2_pins_mx>;
+	pinctrl-1 = <&fdcan2_sleep_pins_mx>;
+	status = "okay";
+
+	/* USER CODE BEGIN m_can2 */
+	/* USER CODE END m_can2 */
+};
+
 &m4_crc2{
 	status = "okay";
 
@@ -892,20 +981,18 @@
 	/* USER CODE END m4_crc2 */
 };
 
-&m4_hash2{
+&m4_dma2{
 	status = "okay";
 
-	/* USER CODE BEGIN m4_hash2 */
-	/* USER CODE END m4_hash2 */
+	/* USER CODE BEGIN m4_dma2 */
+	/* USER CODE END m4_dma2 */
 };
 
-&m4_i2c2{
-	pinctrl-names = "default";
-	pinctrl-0 = <&m4_i2c2_pins_mx>;
+&m4_hash2{
 	status = "okay";
 
-	/* USER CODE BEGIN m4_i2c2 */
-	/* USER CODE END m4_i2c2 */
+	/* USER CODE BEGIN m4_hash2 */
+	/* USER CODE END m4_hash2 */
 };
 
 &m4_i2c5{
@@ -926,16 +1013,6 @@
 	/* USER CODE END m4_m_can1 */
 };
 
-&m_can2{
-	pinctrl-names = "default", "sleep";
-	pinctrl-0 = <&fdcan2_pins_mx>;
-	pinctrl-1 = <&fdcan2_sleep_pins_mx>;
-	status = "okay";
-
-	/* USER CODE BEGIN m_can2 */
-	/* USER CODE END m_can2 */
-};
-
 &m4_rng2{
 	status = "okay";
 
@@ -952,13 +1029,11 @@
 	/* USER CODE END m4_spi4 */
 };
 
-&m4_usart2{
-	pinctrl-names = "default";
-	pinctrl-0 = <&m4_usart2_pins_mx>;
+&mdma1{
 	status = "okay";
 
-	/* USER CODE BEGIN m4_usart2 */
-	/* USER CODE END m4_usart2 */
+	/* USER CODE BEGIN mdma1 */
+	/* USER CODE END mdma1 */
 };
 
 &pwr_regulators{
@@ -993,7 +1068,7 @@
 };
 
 &sdmmc1{
-	u-boot,dm-spl;
+	u-boot,dm-pre-reloc;
 	pinctrl-names = "default", "opendrain", "sleep";
 	pinctrl-0 = <&sdmmc1_pins_mx>;
 	pinctrl-1 = <&sdmmc1_opendrain_pins_mx>;
@@ -1009,6 +1084,7 @@
 };
 
 &sdmmc2{
+	u-boot,dm-pre-reloc;
 	pinctrl-names = "default", "opendrain", "sleep";
 	pinctrl-0 = <&sdmmc2_b4_pins_mx &sdmmc2_d47_pins_mx>;
 	pinctrl-1 = <&sdmmc2_b4_opendrain_pins_mx &sdmmc2_d47_pins_mx>;
@@ -1024,8 +1100,6 @@
 	vmmc-supply = <&v3v3>;
 	vqmmc-supply = <&vdd>;
 	mmc-ddr-3_3v;
-	no-1-8-v;
-	disable-wp;
 	/* USER CODE END sdmmc2 */
 };
 
@@ -1040,7 +1114,6 @@
 	status = "okay";
 
 	/* USER CODE BEGIN timers6 */
-	/* spare dmas for other usage */
 	/delete-property/dmas;
 	/delete-property/dma-names;
 	timer@5 {
@@ -1050,10 +1123,9 @@
 };
 
 &uart4{
-	pinctrl-names = "default", "sleep", "idle";
+	pinctrl-names = "default", "sleep";
 	pinctrl-0 = <&uart4_pins_mx>;
 	pinctrl-1 = <&uart4_sleep_pins_mx>;
-	pinctrl-2 = <&uart4_idle_pins_mx>;
 	status = "okay";
 
 	/* USER CODE BEGIN uart4 */
@@ -1077,11 +1149,22 @@
 	/* USER CODE END uart8 */
 };
 
+&usart2{
+	pinctrl-names = "default", "sleep";
+	pinctrl-0 = <&usart2_pins_mx>;
+	pinctrl-1 = <&usart2_sleep_pins_mx>;
+	status = "okay";
+
+	/* USER CODE BEGIN usart2 */
+	/delete-property/dmas;
+	/delete-property/dma-names;
+	/* USER CODE END usart2 */
+};
+
 &usart3{
-	pinctrl-names = "default", "sleep", "idle";
+	pinctrl-names = "default", "sleep";
 	pinctrl-0 = <&usart3_pins_mx>;
 	pinctrl-1 = <&usart3_sleep_pins_mx>;
-	pinctrl-2 = <&usart3_idle_pins_mx>;
 	status = "okay";
 
 	/* USER CODE BEGIN usart3 */
@@ -1100,8 +1183,10 @@
 };
 
 &usbotg_hs{
-	pinctrl-names = "default";
+	u-boot,dm-pre-reloc;
+	pinctrl-names = "default", "sleep";
 	pinctrl-0 = <&usb_otg_hs_pins_mx>;
+	pinctrl-1 = <&usb_otg_hs_sleep_pins_mx>;
 	status = "okay";
 
 	/* USER CODE BEGIN usbotg_hs */
@@ -1113,26 +1198,30 @@
 };
 
 &usbphyc{
+	u-boot,dm-pre-reloc;
 	status = "okay";
 
 	/* USER CODE BEGIN usbphyc */
-	vdd3v3-supply = <&vdd_usb>;
 	/* USER CODE END usbphyc */
 };
 
 &usbphyc_port0{
+	u-boot,dm-pre-reloc;
+	status = "okay";
 
 	/* USER CODE BEGIN usbphyc_port0 */
-	phy-supply = <&vdd_usb>; 
 	st,phy-tuning = <&usb_phy_tuning>;
+	phy-supply = <&vdd_usb>;
 	/* USER CODE END usbphyc_port0 */
 };
 
 &usbphyc_port1{
+	u-boot,dm-pre-reloc;
+	status = "okay";
 
 	/* USER CODE BEGIN usbphyc_port1 */
-	phy-supply = <&vdd_usb>; 
 	st,phy-tuning = <&usb_phy_tuning>;
+	phy-supply = <&vdd_usb>;
 	/* USER CODE END usbphyc_port1 */
 };
 
@@ -1147,51 +1236,6 @@
 };
 
 /* USER CODE BEGIN addons */
-&dsi {
-	#address-cells = <1>;
-	#size-cells = <0>;
-	status = "okay";
-
-	ports {
-		#address-cells = <1>;
-		#size-cells = <0>;
-
-		port@0 {
-			reg = <0>;
-			dsi_in: endpoint {
-				remote-endpoint = <&ltdc_ep1_out>;
-			};
-		};
-
-		port@1 {
-			reg = <1>;
-			dsi_out: endpoint {
-				remote-endpoint = <&panel_in>;
-			};
-		};
-	};
-
-	panel: panel@0 {
-		compatible = "orisetech,otm8009a";
-		reg = <0>;
-		reset-gpios = <&gpioe 4 GPIO_ACTIVE_LOW>;
-		power-supply = <&v3v3>;
-		backlight = <&panel_backlight>;
-		status = "okay";
-
-		port {
-			panel_in: endpoint {
-				remote-endpoint = <&dsi_out>;
-			};
-		};
-	};
-};
-
-&m4_rproc {
-memory-region = <&retram>, <&mcuram>, <&mcuram2>, <&vdev0vring0>,
-		<&vdev0vring1>, <&vdev0buffer>;
-};
-
 &cpu0{
 	cpu-supply = <&vddcore>;
 };
@@ -1206,13 +1250,5 @@ memory-region = <&retram>, <&mcuram>, <&mcuram2>, <&vdev0vring0>,
 		pool;
 	};
 };
-
-&dma1 {
-	sram = <&dma_pool>;
-};
-
-&dma2 {
-	sram = <&dma_pool>;
-};
 /* USER CODE END addons */
 
-- 
2.30.0

