From 787ba1acfbda094031e32ea92d252435879ac65b Mon Sep 17 00:00:00 2001
From: Mahdi Noori <nekorawesh@gmail.com>
Date: Mon, 21 Dec 2020 16:43:45 +0300
Subject: [PATCH] added mmc1

---
 arch/arm/dts/maestro-cpx-u-boot.dtsi |   8 ++
 arch/arm/dts/maestro-cpx.dts         | 125 ++++++++++++++++++---------
 2 files changed, 92 insertions(+), 41 deletions(-)

diff --git a/arch/arm/dts/maestro-cpx-u-boot.dtsi b/arch/arm/dts/maestro-cpx-u-boot.dtsi
index c176e588ec..7d4721bd7e 100755
--- a/arch/arm/dts/maestro-cpx-u-boot.dtsi
+++ b/arch/arm/dts/maestro-cpx-u-boot.dtsi
@@ -24,6 +24,7 @@
 	aliases {
 		i2c0 = &i2c4;
 		mmc0 = &sdmmc1;
+		mmc1 = &sdmmc2;
 	};
 	config {
 		u-boot,boot-led = "alive";
@@ -190,6 +191,13 @@
 	/* USER CODE END sdmmc1 */
 };
 
+&sdmmc2{
+	u-boot,dm-spl;
+
+	/* USER CODE BEGIN sdmmc2 */
+	/* USER CODE END sdmmc2 */
+};
+
 &uart8{
 	u-boot,dm-pre-reloc;
 
diff --git a/arch/arm/dts/maestro-cpx.dts b/arch/arm/dts/maestro-cpx.dts
index b4905d480d..ebac9015de 100755
--- a/arch/arm/dts/maestro-cpx.dts
+++ b/arch/arm/dts/maestro-cpx.dts
@@ -276,7 +276,20 @@
 		};
 	};
 
-	m4_fdcan2_pins_mx: m4_fdcan2_mx-0 {
+	fdcan2_pins_mx: fdcan2_mx-0 {
+		pins1 {
+			pinmux = <STM32_PINMUX('B', 5, AF9)>; /* FDCAN2_RX */
+			bias-disable;
+		};
+		pins2 {
+			pinmux = <STM32_PINMUX('B', 6, AF9)>; /* FDCAN2_TX */
+			bias-disable;
+			drive-push-pull;
+			slew-rate = <0>;
+		};
+	};
+
+	fdcan2_sleep_pins_mx: fdcan2_sleep_mx-0 {
 		pins {
 			pinmux = <STM32_PINMUX('B', 5, ANALOG)>, /* FDCAN2_RX */
 					 <STM32_PINMUX('B', 6, ANALOG)>; /* FDCAN2_TX */
@@ -376,72 +389,101 @@
 		};
 	};
 
-	sdmmc2_pins_mx: sdmmc2_mx-0 {
+	sdmmc2_b4_pins_mx: sdmmc2_b4_mx-0 {
+		u-boot,dm-spl;
 		pins1 {
-			pinmux = <STM32_PINMUX('A', 8, AF9)>, /* SDMMC2_D4 */
+			u-boot,dm-spl;
+			pinmux = <STM32_PINMUX('B', 14, AF9)>, /* SDMMC2_D0 */
+					 <STM32_PINMUX('B', 15, AF9)>, /* SDMMC2_D1 */
 					 <STM32_PINMUX('B', 3, AF9)>, /* SDMMC2_D2 */
 					 <STM32_PINMUX('B', 4, AF9)>, /* SDMMC2_D3 */
-					 <STM32_PINMUX('B', 9, AF10)>, /* SDMMC2_D5 */
-					 <STM32_PINMUX('B', 14, AF9)>, /* SDMMC2_D0 */
-					 <STM32_PINMUX('B', 15, AF9)>, /* SDMMC2_D1 */
-					 <STM32_PINMUX('C', 7, AF10)>, /* SDMMC2_D7 */
-					 <STM32_PINMUX('E', 5, AF9)>, /* SDMMC2_D6 */
 					 <STM32_PINMUX('G', 6, AF10)>; /* SDMMC2_CMD */
-			bias-disable;
-			drive-push-pull;
 			slew-rate = <1>;
+			drive-push-pull;
+			bias-pull-up;
 		};
 		pins2 {
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('E', 3, AF9)>; /* SDMMC2_CK */
-			bias-disable;
-			drive-push-pull;
 			slew-rate = <2>;
+			drive-push-pull;
+			bias-pull-up;
 		};
 	};
 
-	sdmmc2_opendrain_pins_mx: sdmmc2_opendrain_mx-0 {
+	sdmmc2_b4_opendrain_pins_mx: sdmmc2_b4_opendrain_mx-0 {
+		u-boot,dm-spl;
 		pins1 {
-			pinmux = <STM32_PINMUX('A', 8, AF9)>, /* SDMMC2_D4 */
-					 <STM32_PINMUX('B', 3, AF9)>, /* SDMMC2_D2 */
-					 <STM32_PINMUX('B', 4, AF9)>, /* SDMMC2_D3 */
-					 <STM32_PINMUX('B', 9, AF10)>, /* SDMMC2_D5 */
-					 <STM32_PINMUX('B', 14, AF9)>, /* SDMMC2_D0 */
+			u-boot,dm-spl;
+			pinmux = <STM32_PINMUX('B', 14, AF9)>, /* SDMMC2_D0 */
 					 <STM32_PINMUX('B', 15, AF9)>, /* SDMMC2_D1 */
-					 <STM32_PINMUX('C', 7, AF10)>, /* SDMMC2_D7 */
-					 <STM32_PINMUX('E', 5, AF9)>; /* SDMMC2_D6 */
-			bias-disable;
-			drive-push-pull;
+					 <STM32_PINMUX('B', 3, AF9)>, /* SDMMC2_D2 */
+					 <STM32_PINMUX('B', 4, AF9)>; /* SDMMC2_D3 */
 			slew-rate = <1>;
+			drive-push-pull;
+			bias-pull-up;
 		};
 		pins2 {
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('E', 3, AF9)>; /* SDMMC2_CK */
-			bias-disable;
-			drive-push-pull;
 			slew-rate = <2>;
+			drive-push-pull;
+			bias-pull-up;
 		};
 		pins3 {
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('G', 6, AF10)>; /* SDMMC2_CMD */
-			bias-disable;
-			drive-open-drain;
 			slew-rate = <1>;
+			drive-open-drain;
+			bias-pull-up;
 		};
 	};
 
-	sdmmc2_sleep_pins_mx: sdmmc2_sleep_mx-0 {
+	sdmmc2_b4_sleep_pins_mx: sdmmc2_b4_sleep_mx-0 {
+		u-boot,dm-spl;
 		pins {
-			pinmux = <STM32_PINMUX('A', 8, ANALOG)>, /* SDMMC2_D4 */
+			u-boot,dm-spl;
+			pinmux = <STM32_PINMUX('B', 14, ANALOG)>, /* SDMMC2_D0 */
+					 <STM32_PINMUX('B', 15, ANALOG)>, /* SDMMC2_D1 */
 					 <STM32_PINMUX('B', 3, ANALOG)>, /* SDMMC2_D2 */
 					 <STM32_PINMUX('B', 4, ANALOG)>, /* SDMMC2_D3 */
-					 <STM32_PINMUX('B', 9, ANALOG)>, /* SDMMC2_D5 */
-					 <STM32_PINMUX('B', 14, ANALOG)>, /* SDMMC2_D0 */
-					 <STM32_PINMUX('B', 15, ANALOG)>, /* SDMMC2_D1 */
-					 <STM32_PINMUX('C', 7, ANALOG)>, /* SDMMC2_D7 */
 					 <STM32_PINMUX('E', 3, ANALOG)>, /* SDMMC2_CK */
-					 <STM32_PINMUX('E', 5, ANALOG)>, /* SDMMC2_D6 */
 					 <STM32_PINMUX('G', 6, ANALOG)>; /* SDMMC2_CMD */
 		};
 	};
 
+	sdmmc2_d47_pins_mx: sdmmc2_d47_mx-0 {
+		u-boot,dm-spl;
+		pins1 {
+			u-boot,dm-spl;
+			pinmux = <STM32_PINMUX('A', 8, AF9)>, /* SDMMC2_D4 */
+					 <STM32_PINMUX('B', 9, AF10)>, /* SDMMC2_D5 */
+					 <STM32_PINMUX('E', 5, AF9)>, /* SDMMC2_D6 */
+					 <STM32_PINMUX('C', 7, AF10)>; /* SDMMC2_D7 */
+			slew-rate = <1>;
+			drive-push-pull;
+			bias-pull-up;
+		};
+		pins2 {
+			u-boot,dm-spl;
+			pinmux = <STM32_PINMUX('E', 3, AF9)>; /* SDMMC2_CK */
+			slew-rate = <2>;
+			drive-push-pull;
+			bias-pull-up;
+		};
+	};
+
+	sdmmc2_d47_sleep_pins_mx: sdmmc2_d47_sleep_mx-0 {
+		u-boot,dm-spl;
+		pins {
+			u-boot,dm-spl;
+			pinmux = <STM32_PINMUX('A', 8, ANALOG)>, /* SDMMC2_D4 */
+					 <STM32_PINMUX('B', 9, ANALOG)>, /* SDMMC2_D5 */
+					 <STM32_PINMUX('E', 5, ANALOG)>, /* SDMMC2_D6 */
+					 <STM32_PINMUX('C', 7, ANALOG)>; /* SDMMC2_D7 */
+		};
+	};
+
 	uart4_pins_mx: uart4_mx-0 {
 		pins1 {
 			pinmux = <STM32_PINMUX('A', 13, AF8)>; /* UART4_TX */
@@ -901,13 +943,14 @@
 	/* USER CODE END m4_m_can1 */
 };
 
-&m4_m_can2{
-	pinctrl-names = "default";
-	pinctrl-0 = <&m4_fdcan2_pins_mx>;
+&m_can2{
+	pinctrl-names = "default", "sleep";
+	pinctrl-0 = <&fdcan2_pins_mx>;
+	pinctrl-1 = <&fdcan2_sleep_pins_mx>;
 	status = "okay";
 
-	/* USER CODE BEGIN m4_m_can2 */
-	/* USER CODE END m4_m_can2 */
+	/* USER CODE BEGIN m_can2 */
+	/* USER CODE END m_can2 */
 };
 
 &m4_rng2{
@@ -985,9 +1028,9 @@
 
 &sdmmc2{
 	pinctrl-names = "default", "opendrain", "sleep";
-	pinctrl-0 = <&sdmmc2_pins_mx>;
-	pinctrl-1 = <&sdmmc2_opendrain_pins_mx>;
-	pinctrl-2 = <&sdmmc2_sleep_pins_mx>;
+	pinctrl-0 = <&sdmmc2_b4_pins_mx &sdmmc2_d47_pins_mx>;
+	pinctrl-1 = <&sdmmc2_b4_opendrain_pins_mx &sdmmc2_d47_pins_mx>;
+	pinctrl-2 = <&sdmmc2_b4_sleep_pins_mx &sdmmc2_d47_sleep_pins_mx>;
 	status = "okay";
 
 	/* USER CODE BEGIN sdmmc2 */
-- 
2.29.2

