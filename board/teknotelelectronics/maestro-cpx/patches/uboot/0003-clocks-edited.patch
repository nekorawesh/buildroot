From d7d44f2f4e6c4e0e656301c150699f85fe979bed Mon Sep 17 00:00:00 2001
From: Mahdi Noori <nekorawesh@gmail.com>
Date: Thu, 7 Jan 2021 14:56:25 +0300
Subject: [PATCH] clocks edited

---
 arch/arm/dts/maestro-cpx-u-boot.dtsi |  25 +++--
 arch/arm/dts/maestro-cpx.dts         | 131 ++++++++++++++-------------
 arch/arm/dts/maestro-cpx.dtsi        |  26 +++---
 3 files changed, 99 insertions(+), 83 deletions(-)

diff --git a/arch/arm/dts/maestro-cpx-u-boot.dtsi b/arch/arm/dts/maestro-cpx-u-boot.dtsi
index bfd1ab15cc..445c0ded0d 100755
--- a/arch/arm/dts/maestro-cpx-u-boot.dtsi
+++ b/arch/arm/dts/maestro-cpx-u-boot.dtsi
@@ -20,9 +20,13 @@
 / {
 
 	/* USER CODE BEGIN root */
+	aliases {
+		i2c0 = &i2c4;
+		mmc0 = &sdmmc1;
+		mmc1 = &sdmmc2;
+	};
+
 	config {
-		u-boot,boot-led = "alive";
-		u-boot,error-led = "comm";
 		u-boot,mmc-env-partition = "ssbl";
 	};
 
@@ -130,7 +134,7 @@
 		CLK_UART6_DISABLED
 		CLK_UART78_HSI
 		CLK_SPDIF_DISABLED
-		CLK_FDCAN_PLL4Q
+		CLK_FDCAN_PLL4R
 		CLK_SAI1_DISABLED
 		CLK_SAI2_DISABLED
 		CLK_SAI3_DISABLED
@@ -144,19 +148,21 @@
 	pll2:st,pll@1 {
 		compatible = "st,stm32mp1-pll";
 		reg = <1>;
-		cfg = < 2 63 1 0 0 PQR(1,1,1) >;
+		cfg = < 2 65 1 0 0 PQR(1,1,1) >;
+		frac = < 0x1400 >;
 		u-boot,dm-pre-reloc;
 	};
 	pll3:st,pll@2 {
 		compatible = "st,stm32mp1-pll";
 		reg = <2>;
-		cfg = < 1 49 2 4 5 PQR(1,0,0) >;
+		cfg = < 1 33 1 16 36 PQR(1,0,0) >;
+		frac = < 0x1a04 >;
 		u-boot,dm-pre-reloc;
 	};
 	pll4:st,pll@3 {
 		compatible = "st,stm32mp1-pll";
 		reg = <3>;
-		cfg = < 1 39 3 5 5 PQR(1,1,0) >;
+		cfg = < 3 98 5 7 7 PQR(1,1,1) >;
 		u-boot,dm-pre-reloc;
 	};
 };
@@ -169,14 +175,14 @@
 };
 
 &sdmmc1{
-	u-boot,dm-pre-reloc;
+	u-boot,dm-spl;
 
 	/* USER CODE BEGIN sdmmc1 */
 	/* USER CODE END sdmmc1 */
 };
 
 &sdmmc2{
-	u-boot,dm-pre-reloc;
+	u-boot,dm-spl;
 
 	/* USER CODE BEGIN sdmmc2 */
 	/* USER CODE END sdmmc2 */
@@ -202,6 +208,9 @@
 	u-boot,dm-pre-reloc;
 
 	/* USER CODE BEGIN usbotg_hs */
+	u-boot,force-b-session-valid;
+	hnp-srp-disable;
+	dr_mode = "peripheral";      
 	/* USER CODE END usbotg_hs */
 };
 
diff --git a/arch/arm/dts/maestro-cpx.dts b/arch/arm/dts/maestro-cpx.dts
index 6ad30fae92..404b8436d9 100755
--- a/arch/arm/dts/maestro-cpx.dts
+++ b/arch/arm/dts/maestro-cpx.dts
@@ -90,22 +90,6 @@
 		stdout-path = "serial0:115200n8";
 	};
 
-	led {
-		compatible = "gpio-leds";
-		alive {
-			label = "alive";
-			gpios = <&gpiof 8 GPIO_ACTIVE_HIGH>;
-			linux,default-trigger = "heartbeat";
-			default-state = "off";
-		};
-
-		comm {
-			label = "comm";
-			gpios = <&gpiof 10 GPIO_ACTIVE_LOW>;
-			default-state = "off";
-		};
-	};
-
 	usb_phy_tuning: usb-phy-tuning {
 		st,hs-dc-level = <2>;
 		st,fs-rftime-tuning;
@@ -317,9 +301,9 @@
 	};
 
 	sdmmc1_pins_mx: sdmmc1_mx-0 {
-		u-boot,dm-pre-reloc;
+		u-boot,dm-spl;
 		pins1 {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('C', 8, AF12)>, /* SDMMC1_D0 */
 					 <STM32_PINMUX('C', 9, AF12)>, /* SDMMC1_D1 */
 					 <STM32_PINMUX('C', 10, AF12)>, /* SDMMC1_D2 */
@@ -330,7 +314,7 @@
 			slew-rate = <1>;
 		};
 		pins2 {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('C', 12, AF12)>; /* SDMMC1_CK */
 			bias-disable;
 			drive-push-pull;
@@ -339,9 +323,9 @@
 	};
 
 	sdmmc1_opendrain_pins_mx: sdmmc1_opendrain_mx-0 {
-		u-boot,dm-pre-reloc;
+		u-boot,dm-spl;
 		pins1 {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('C', 8, AF12)>, /* SDMMC1_D0 */
 					 <STM32_PINMUX('C', 9, AF12)>, /* SDMMC1_D1 */
 					 <STM32_PINMUX('C', 10, AF12)>, /* SDMMC1_D2 */
@@ -351,14 +335,14 @@
 			slew-rate = <1>;
 		};
 		pins2 {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('C', 12, AF12)>; /* SDMMC1_CK */
 			bias-disable;
 			drive-push-pull;
 			slew-rate = <2>;
 		};
 		pins3 {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('D', 2, AF12)>; /* SDMMC1_CMD */
 			bias-disable;
 			drive-open-drain;
@@ -367,9 +351,9 @@
 	};
 
 	sdmmc1_sleep_pins_mx: sdmmc1_sleep_mx-0 {
-		u-boot,dm-pre-reloc;
+		u-boot,dm-spl;
 		pins {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('C', 8, ANALOG)>, /* SDMMC1_D0 */
 					 <STM32_PINMUX('C', 9, ANALOG)>, /* SDMMC1_D1 */
 					 <STM32_PINMUX('C', 10, ANALOG)>, /* SDMMC1_D2 */
@@ -380,9 +364,9 @@
 	};
 
 	sdmmc2_b4_pins_mx: sdmmc2_b4_mx-0 {
-		u-boot,dm-pre-reloc;
+		u-boot,dm-spl;
 		pins1 {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('B', 14, AF9)>, /* SDMMC2_D0 */
 					 <STM32_PINMUX('B', 15, AF9)>, /* SDMMC2_D1 */
 					 <STM32_PINMUX('B', 3, AF9)>, /* SDMMC2_D2 */
@@ -393,7 +377,7 @@
 			bias-pull-up;
 		};
 		pins2 {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('E', 3, AF9)>; /* SDMMC2_CK */
 			slew-rate = <2>;
 			drive-push-pull;
@@ -402,9 +386,9 @@
 	};
 
 	sdmmc2_b4_opendrain_pins_mx: sdmmc2_b4_opendrain_mx-0 {
-		u-boot,dm-pre-reloc;
+		u-boot,dm-spl;
 		pins1 {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('B', 14, AF9)>, /* SDMMC2_D0 */
 					 <STM32_PINMUX('B', 15, AF9)>, /* SDMMC2_D1 */
 					 <STM32_PINMUX('B', 3, AF9)>, /* SDMMC2_D2 */
@@ -414,14 +398,14 @@
 			bias-pull-up;
 		};
 		pins2 {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('E', 3, AF9)>; /* SDMMC2_CK */
 			slew-rate = <2>;
 			drive-push-pull;
 			bias-pull-up;
 		};
 		pins3 {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('G', 6, AF10)>; /* SDMMC2_CMD */
 			slew-rate = <1>;
 			drive-open-drain;
@@ -430,9 +414,9 @@
 	};
 
 	sdmmc2_b4_sleep_pins_mx: sdmmc2_b4_sleep_mx-0 {
-		u-boot,dm-pre-reloc;
+		u-boot,dm-spl;
 		pins {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('B', 14, ANALOG)>, /* SDMMC2_D0 */
 					 <STM32_PINMUX('B', 15, ANALOG)>, /* SDMMC2_D1 */
 					 <STM32_PINMUX('B', 3, ANALOG)>, /* SDMMC2_D2 */
@@ -443,9 +427,9 @@
 	};
 
 	sdmmc2_d47_pins_mx: sdmmc2_d47_mx-0 {
-		u-boot,dm-pre-reloc;
+		u-boot,dm-spl;
 		pins1 {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('A', 8, AF9)>, /* SDMMC2_D4 */
 					 <STM32_PINMUX('B', 9, AF10)>, /* SDMMC2_D5 */
 					 <STM32_PINMUX('E', 5, AF9)>, /* SDMMC2_D6 */
@@ -457,9 +441,9 @@
 	};
 
 	sdmmc2_d47_sleep_pins_mx: sdmmc2_d47_sleep_mx-0 {
-		u-boot,dm-pre-reloc;
+		u-boot,dm-spl;
 		pins {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-spl;
 			pinmux = <STM32_PINMUX('A', 8, ANALOG)>, /* SDMMC2_D4 */
 					 <STM32_PINMUX('B', 9, ANALOG)>, /* SDMMC2_D5 */
 					 <STM32_PINMUX('E', 5, ANALOG)>, /* SDMMC2_D6 */
@@ -487,6 +471,16 @@
 		};
 	};
 
+	uart4_idle_pins_mx: uart4_idle_mx-0 {
+		pins1 {
+			pinmux = <STM32_PINMUX('A', 13, ANALOG)>; /* UART4_TX */
+		};
+		pins2 {
+			pinmux = <STM32_PINMUX('B', 2, AF8)>; /* UART4_RX */
+			bias-disable;
+		};
+	};
+
 	uart8_pins_mx: uart8_mx-0 {
 		u-boot,dm-pre-reloc;
 		pins1 {
@@ -503,6 +497,15 @@
 		};
 	};
 
+	uart8_sleep_pins_mx: uart8_sleep_mx-0 {
+		u-boot,dm-pre-reloc;
+		pins {
+			u-boot,dm-pre-reloc;
+			pinmux = <STM32_PINMUX('E', 0, ANALOG)>, /* UART8_RX */
+					 <STM32_PINMUX('E', 1, ANALOG)>; /* UART8_TX */
+		};
+	};
+
 	uart8_idle_pins_mx: uart8_idle_mx-0 {
 		u-boot,dm-pre-reloc;
 		pins1 {
@@ -516,15 +519,6 @@
 		};
 	};
 
-	uart8_sleep_pins_mx: uart8_sleep_mx-0 {
-		u-boot,dm-pre-reloc;
-		pins {
-			u-boot,dm-pre-reloc;
-			pinmux = <STM32_PINMUX('E', 0, ANALOG)>, /* UART8_RX */
-					 <STM32_PINMUX('E', 1, ANALOG)>; /* UART8_TX */
-		};
-	};
-
 	usart2_pins_mx: usart2_mx-0 {
 		pins1 {
 			pinmux = <STM32_PINMUX('D', 5, AF7)>; /* USART2_TX */
@@ -545,6 +539,16 @@
 		};
 	};
 
+	usart2_idle_pins_mx: usart2_idle_mx-0 {
+		pins1 {
+			pinmux = <STM32_PINMUX('D', 5, ANALOG)>; /* USART2_TX */
+		};
+		pins2 {
+			pinmux = <STM32_PINMUX('D', 6, AF7)>; /* USART2_RX */
+			bias-disable;
+		};
+	};
+
 	usart3_pins_mx: usart3_mx-0 {
 		pins1 {
 			pinmux = <STM32_PINMUX('D', 8, AF7)>; /* USART3_TX */
@@ -565,18 +569,20 @@
 		};
 	};
 
-	usb_otg_hs_pins_mx: usb_otg_hs_mx-0 {
-		u-boot,dm-pre-reloc;
-		pins {
-			u-boot,dm-pre-reloc;
-			pinmux = <STM32_PINMUX('A', 10, ANALOG)>; /* USB_OTG_HS_ID */
+	usart3_idle_pins_mx: usart3_idle_mx-0 {
+		pins1 {
+			pinmux = <STM32_PINMUX('D', 8, ANALOG)>; /* USART3_TX */
+		};
+		pins2 {
+			pinmux = <STM32_PINMUX('D', 9, AF7)>; /* USART3_RX */
+			bias-disable;
 		};
 	};
 
-	usb_otg_hs_sleep_pins_mx: usb_otg_hs_sleep_mx-0 {
+	usb_otg_hs_pins_mx: usb_otg_hs_mx-0 {
 		u-boot,dm-pre-reloc;
 		pins {
-			u-boot,dm-pre-reloc;
+			u-boot,dm-pre-reloc;	
 			pinmux = <STM32_PINMUX('A', 10, ANALOG)>; /* USB_OTG_HS_ID */
 		};
 	};
@@ -646,7 +652,6 @@
 };
 
 &dmamux1{
-
 	dma-masters = <&dma1>;
 	dma-channels = <8>;
 
@@ -778,6 +783,7 @@
 		panel = <&panel>;
 		status = "okay";
 	};
+
 	touchscreen@38 {
 		compatible = "focaltech,ft6336";
 		reg = <0x38>;
@@ -941,7 +947,7 @@
 };
 
 &iwdg2{
-	status = "okay";
+	status = "disabled";
 
 	/* USER CODE BEGIN iwdg2 */
 	timeout-sec = <32>;
@@ -1123,9 +1129,10 @@
 };
 
 &uart4{
-	pinctrl-names = "default", "sleep";
+	pinctrl-names = "default", "sleep", "idle";
 	pinctrl-0 = <&uart4_pins_mx>;
 	pinctrl-1 = <&uart4_sleep_pins_mx>;
+	pinctrl-2 = <&uart4_idle_pins_mx>;
 	status = "okay";
 
 	/* USER CODE BEGIN uart4 */
@@ -1150,9 +1157,10 @@
 };
 
 &usart2{
-	pinctrl-names = "default", "sleep";
+	pinctrl-names = "default", "sleep", "idle";
 	pinctrl-0 = <&usart2_pins_mx>;
 	pinctrl-1 = <&usart2_sleep_pins_mx>;
+	pinctrl-2 = <&usart2_idle_pins_mx>;
 	status = "okay";
 
 	/* USER CODE BEGIN usart2 */
@@ -1162,9 +1170,10 @@
 };
 
 &usart3{
-	pinctrl-names = "default", "sleep";
+	pinctrl-names = "default", "sleep", "idle";
 	pinctrl-0 = <&usart3_pins_mx>;
 	pinctrl-1 = <&usart3_sleep_pins_mx>;
+	pinctrl-2 = <&usart3_idle_pins_mx>;
 	status = "okay";
 
 	/* USER CODE BEGIN usart3 */
@@ -1184,9 +1193,8 @@
 
 &usbotg_hs{
 	u-boot,dm-pre-reloc;
-	pinctrl-names = "default", "sleep";
+	pinctrl-names = "default";
 	pinctrl-0 = <&usb_otg_hs_pins_mx>;
-	pinctrl-1 = <&usb_otg_hs_sleep_pins_mx>;
 	status = "okay";
 
 	/* USER CODE BEGIN usbotg_hs */
@@ -1202,6 +1210,7 @@
 	status = "okay";
 
 	/* USER CODE BEGIN usbphyc */
+	vdd3v3-supply = <&vdd_usb>;
 	/* USER CODE END usbphyc */
 };
 
diff --git a/arch/arm/dts/maestro-cpx.dtsi b/arch/arm/dts/maestro-cpx.dtsi
index 398060581d..61dd80c54b 100644
--- a/arch/arm/dts/maestro-cpx.dtsi
+++ b/arch/arm/dts/maestro-cpx.dtsi
@@ -1,8 +1,6 @@
+// SPDX-License-Identifier: GPL-2.0+ OR BSD-3-Clause
 /*
- * Copyright (C) 2015-2018, STMicroelectronics - All Rights Reserved
- *
- * SPDX-License-Identifier:	GPL-2.0+	BSD-3-Clause
- *
+ * Copyright (C) 2018, STMicroelectronics - All Rights Reserved
  */
 
 /*
@@ -10,15 +8,15 @@
  * DDR type: DDR3 / DDR3L
  * DDR width: 16bits
  * DDR density: 4Gb
- * System frequency: 512000Khz
+ * System frequency: 533000Khz
  * Relaxed Timing Mode: false
  * Address mapping type: RBC
  *
- * Save Date: 2021.01.05, save Time: 10:43:11
+ * Save Date: 2020.02.20, save Time: 18:45:20
  */
 
-#define DDR_MEM_NAME	"DDR3-DDR3L 16bits 512000Khz"
-#define DDR_MEM_SPEED	512000
+#define DDR_MEM_NAME	"DDR3-DDR3L 16bits 533000Khz"
+#define DDR_MEM_SPEED	533000
 #define DDR_MEM_SIZE	0x20000000
 
 #define DDR_MSTR 0x00041401
@@ -31,9 +29,9 @@
 #define DDR_HWLPCTL 0x00000000
 #define DDR_RFSHCTL0 0x00210000
 #define DDR_RFSHCTL3 0x00000000
-#define DDR_RFSHTMG 0x007C0086
+#define DDR_RFSHTMG 0x0081008B
 #define DDR_CRCPARCTL0 0x00000000
-#define DDR_DRAMTMG0 0x121A2314
+#define DDR_DRAMTMG0 0x121B2414
 #define DDR_DRAMTMG1 0x000A041C
 #define DDR_DRAMTMG2 0x0608090F
 #define DDR_DRAMTMG3 0x0050400C
@@ -85,15 +83,15 @@
 #define DDR_ADDRMAP10 0x00000000
 #define DDR_ADDRMAP11 0x00000000
 #define DDR_PGCR 0x01442E02
-#define DDR_PTR0 0x00228F9A
-#define DDR_PTR1 0x045BE800
-#define DDR_PTR2 0x042D9000
+#define DDR_PTR0 0x0022AA5B
+#define DDR_PTR1 0x04841104
+#define DDR_PTR2 0x042DA068
 #define DDR_ACIOCR 0x10400812
 #define DDR_DXCCR 0x00000C40
 #define DDR_DSGCR 0xF200011F
 #define DDR_DCR 0x0000000B
 #define DDR_DTPR0 0x38D488D0
-#define DDR_DTPR1 0x098600D0
+#define DDR_DTPR1 0x098B00D8
 #define DDR_DTPR2 0x10023600
 #define DDR_MR0 0x00000840
 #define DDR_MR1 0x00000000
-- 
2.30.0

